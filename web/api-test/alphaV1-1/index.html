<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
<title>Prueba la API</title>
<style>
html { color-scheme: dark; }
body {
    margin: 0 auto;
    width: 35em;
    font-family: Tahoma, Verdana, Arial, sans-serif;
    height: 200vh; }
* { box-sizing: border-box; transition: all 0.5s ease; }
.img{
    border-style: dashed;
    border-color:black;
    border-radius: 30px; }
.container {
    padding-top: 5rem;
    padding-bottom: 5rem; }
.qr {
    display: flex;
    justify-content: center;
    padding: 4rem; }
button{
    height: 40px;
    width: fit-content;
    border: 20px;
    border-radius: 30px;
    margin: 5px;
    font-size: 18px;
    cursor: pointer;
    transition: all 300ms ease; }
button:hover {
    transform: scale(1.1);
    background-image: linear-gradient(45deg, #831e7a, #6313ad, #146a8a, #138168);
	background-size: 400% 400%;
    box-shadow: 0 0 10px rgb(255, 255, 255);
	animation: gradient 5s linear infinite; }
.tablein{ 
    background-color: lightslategray;
}
.tabla_th2{
    width: max-content;
    color: black;
    font-size: 5px;
    text-align: left;
    padding: 1px;
}
.tabla{
    text-align: center;
}
.tabla_th1{
    width: max-content;
    color: black;
    font-size: 5px;
    text-align: left;
    padding: 1px;
    background-color: gray;
    font-weight: bold;
}
</style>
</head>
<body>
    <div>
        <span>alpha v1.1</span>
    </div>
    <div class="container">
    <h1>Prueba la API</h1>
    <label>direccion de la api: </label>
    <br>
    <input type="text" id="host" oninput="hosthandle(false)" size="50" placeholder="https://www.website.com/api" value="../../../api">
    <button onclick="hosthandle(true)">Restablecer</button>
        <div id="hostez"></div>
    </div>
    <div class="tabla">
        <h1>comunicacion json con el servidor</h1>
        <label>hazle zoom para ver Xd</label>
        <table class="tablein">
            <tr>
                <th class="tabla_th1">corto</th>
                <th class="tabla_th1">largo</th>
                <th class="tabla_th1">nombre</th>
                <th class="tabla_th1">descripcion</th>
                <th class="tabla_th1">1 ejemplo</th>
                <th class="tabla_th1">limites / formato</th>
            </tr>
            <tr>
                <th class="tabla_th2">u</th>
                <th class="tabla_th2">user</th>
                <th class="tabla_th2">usuario</th>
                <th class="tabla_th2">nombre unico en el sistema vinculado a cada usuario</th>
                <th class="tabla_th2">usuario_123</th>
                <th class="tabla_th2">64 caracteres</th>
            </tr>
            <tr>
                <th class="tabla_th2">k</th>
                <th class="tabla_th2">key</th>
                <th class="tabla_th2">codigo totp</th>
                <th class="tabla_th2">codigo numerico de 6 digitos generado en base al token de acceso que se utilizara para iniciar sesion</th>
                <th class="tabla_th2">451846</th>
                <th class="tabla_th2">6 numeros</th>
            </tr>
            <tr>
                <th class="tabla_th2">a</th>
                <th class="tabla_th2">access</th>
                <th class="tabla_th2">nivel de acceso</th>
                <th class="tabla_th2">un numero entero que determinara el nivel de acceso que tiene un usuario en el sistema</th>
                <th class="tabla_th2">1</th>
                <th class="tabla_th2">numero entero</th>
            </tr>
            <tr>
                <th class="tabla_th2">fn</th>
                <th class="tabla_th2">firstname</th>
                <th class="tabla_th2">nombre</th>
                <th class="tabla_th2">nombre de un usuario registrado, puede incluir varios nombres si es necesario</th>
                <th class="tabla_th2">Jose</th>
                <th class="tabla_th2">64 caracteres</th>
            </tr>
            <tr>
                <th class="tabla_th2">ln</th>
                <th class="tabla_th2">lastname</th>
                <th class="tabla_th2">apellido</th>
                <th class="tabla_th2">apellido de un usuario registrado, puede incluir varios apellidos si es necesario</th>
                <th class="tabla_th2">Manuel</th>
                <th class="tabla_th2">64 caracteres</th>
            </tr>
            <tr>
                <th class="tabla_th2">s</th>
                <th class="tabla_th2">session</th>
                <th class="tabla_th2">token de sesion</th>
                <th class="tabla_th2">token generada por el servidor cada vez que se inicia sesion, y se utiliza para autorizar el usuario</th>
                <th class="tabla_th2">3FqNnvEgqaNo19UES7g_ww9-5ANVRQpKwn2n9grnQlEEv-K6QDsNUbicCQYcIzoJ</th>
                <th class="tabla_th2">64 caracteres base64HTMLmod</th>
            </tr>
            <tr>
                <th class="tabla_th2">x</th>
                <th class="tabla_th2">private</th>
                <th class="tabla_th2">token de acceso qr</th>
                <th class="tabla_th2">se guarda en un qr o en google authenticator y se usa para generar el codigo totp de 6 digitos</th>
                <th class="tabla_th2">MZMWGUKDN5GVO3CO</th>
                <th class="tabla_th2">16 caracteres base32</th>
            </tr>
        </table>
    <div class="container">
    </div>
</div>
<h1>Endpoints</h1>
<div class="container">
    <h2>/login</h2>
    <label>usuario:</label>
    <input type="text" id="login-usuario" oninput="login(false)" maxlength="64">
    <label>totp:</label>
    <input type="text" id="login-totp" oninput="login(false)" maxlength="6" size="8">
    <button onclick="login(true)">Enviar POST</button>
    <br>
    <br>
    <label>Solicitud JSON = </label>
    <code id="login-in"></code>
    <br>
    <label>Respuesta JSON = </label>
    <code id="login-out">{}</code>
    <br>
    <label>Codigo de estado de respuesta HTML = </label>
    <code id="login-statuscode">
        0 UNDEFINED
    </code>
</div>
<div class="container">
    <h2>/register</h2>
    <label>sesion vinculada a una cuenta admin:</label>
    <input type="text" id="register-token" oninput="register(false)" maxlength="64" size="72">
    <br>
    <label>usuario:</label>
    <input type="text" id="register-usuario" oninput="register(false)" maxlength="64">
    <br>
    <label>nombre:</label>
    <input type="text" id="register-fn" oninput="register(false)" maxlength="64">
    <br>
    <label>apellido:</label>
    <input type="text" id="register-ln" oninput="register(false)" maxlength="64">
    <label>nivel de acceso:</label>
    <input type="number" id="register-access" oninput="register(false)" min="0" max="5" value="0" size="4">
    <button onclick="register(true)">Enviar POST</button>
    <br>
    <label>mostrar codigo QR: </label>
    <input type="checkbox" id="register-qr-gen" oninput="qrmadein()" value="true">
    <br>
    <br>
    <label>Solicitud JSON = </label>
    <code id="register-in"></code>
    <br>
    <label>Respuesta JSON = </label>
    <code id="register-out">{}</code>
    <br>
    <label>Codigo de estado de respuesta HTML = </label>
    <code id="register-statuscode">
        0 UNDEFINED
    </code>
    <br>
    <br>
    <div id="register-qr" class="qr"></div>
    <label id="register-qr-label"></label>
</div>
<div class="container">
    <h2>/logout</h2>

    <label>token de sesion activa a cerrar:</label>
    <br>
    <input type="text" id="logout-session" oninput="logout(false)" maxlength="64" size="72">
    <br>
    <label>Cerrar todas las sesiones vinculadas a esa cuenta:</label>
    <input type="checkbox" id="logout-all" onchange="logout(false)">
    <br>
    <button onclick="logout(true)">Enviar POST</button>
    <br>
    <br>
    <label>Solicitud JSON = </label>
    <code id="logout-in"></code>
    <br>
    <label>Respuesta JSON = </label>
    <code id="logout-out">{}</code>
    <br>
    <label>Codigo de estado de respuesta HTML = </label>
    <code id="logout-statuscode">
        0 UNDEFINED
    </code>
</div>
<div class="container">
    <h2>/unregister</h2>
    <label>usuario:</label>
    <input type="text" id="unregister-usuario" oninput="unregister(false)" maxlength="64">
    <label>totp:</label>
    <input type="text" id="unregister-totp" oninput="unregister(false)" maxlength="6" size="8">
    <button onclick="unregister(true)">Enviar POST</button>
    <br>
    <br>
    <label>Solicitud JSON = </label>
    <code id="unregister-in"></code>
    <br>
    <label>Respuesta JSON = </label>
    <code id="unregister-out">{}</code>
    <br>
    <label>Codigo de estado de respuesta HTML = </label>
    <code id="unregister-statuscode">
        0 UNDEFINED
    </code>
</div>
<div class="container">
    <h2>/userinfo</h2>
    <label>Token de sesion: </label>
    <input type="text" id="userinfo-session" maxlength="64" size="72" oninput="userinfo(false)">
    <br>
    <h3>Recuperar informacion de: </h3>
    <br>
    <label>usuarios: </label>
    <br>
    <textarea id="userinfo-users" rows="4" cols="30" placeholder="UserName1, UserName2, UserName3, UserId4, UserId5 ..." oninput="userinfo(false)"></textarea>
    <br>
    <label>todos los usuarios</label>
    <input type="checkbox" id="userinfo-all-users" onchange="userinfo(false)">
    <br>
    <h3>Â¿Que desea Recuperar?</h3>
    <br>
    <label>id / identificador numerico: </label>
    <input type="checkbox" id="userinfo-id" onchange="userinfo(false)">
    <br>
    <label>username / usuario: </label>
    <input type="checkbox" id="userinfo-user" onchange="userinfo(false)">
    <br>
    <label>first name / nombre: </label>
    <input type="checkbox" id="userinfo-name" onchange="userinfo(false)">
    <br>
    <label>last name / apellido: </label>
    <input type="checkbox" id="userinfo-lname" onchange="userinfo(false)">
    <br>
    <label>access level / nivel de acceso: </label>
    <input type="checkbox" id="userinfo-access" onchange="userinfo(false)">
    <br>
    <label>created at / fecha de creacion: </label>
    <input type="checkbox" id="userinfo-create" onchange="userinfo(false)">
    <button onclick="userinfo(2)">Seleccionar todo</button>
    <br>
    <br>
    <label>Limit: </label>
    <input type="number" id="userinfo-limit" min="0" max="1000" size="6" value="100" oninput="userinfo(false)">
    <label>Offset: </label>
    <input type="number" id="userinfo-offset" min="0" max="100" size="6" value="0" oninput="userinfo(false)">
    
    <br>
    <button onclick="userinfo(true)">Enviar GET</button>
    <br>
    <br>
    <label>Solicitud HTML = </label>
    <br>
    <code id="userinfo-in"></code>
    <br>
    <br>
    <label>Respuesta JSON = </label>
    <code id="userinfo-out">{}</code>
    <br>
    <label>Codigo de estado de respuesta HTML = </label>
    <code id="userinfo-statuscode">
        0 UNDEFINED
    </code>
</div>
<div class="container">
    <h2>/test</h2>
    <label>argumentos en url: </label>
    <textarea id="test-url" rows="4" cols="30" placeholder="Argumento1, Argumento2, Argumento3, ..." oninput="test(false)"></textarea>
    <br>
    <label>argumentos en uri: </label>
    <textarea id="test-uri" rows="4" cols="30" placeholder="Argumento1=Valor1, Argumento2=Valor2, Argumento3=Valor3, ..." oninput="test(false)"></textarea>
    <br>
    <button onclick="test(true)">Enviar GET</button>
    <br>
    <br>
    <label>Solicitud HTML = </label>
    <code id="test-in"></code>
    <br>
    <label>Respuesta JSON = </label>
    <code id="test-out">{}</code>
    <br>
    <label>Codigo de estado de respuesta HTML = </label>
    <code id="test-statuscode">
        0 UNDEFINED
    </code>
</div>
<script>
//var DEF_HOST = "../../api"
var DEF_HOST = ""
var TEMPLATE_POST = {method: 'POST',headers: {'Content-Type': 'application/json',},}
var host = ""
var qr_inner = {}

hosthandle(false)
login(false)
register(false)
logout(false)
unregister(false)
userinfo(false)
test(false)
hostez()

function qrmadein(){
    if(document.getElementById("register-qr-gen").checked && Object.keys(qr_inner).length !== 0){
        document.getElementById("register-qr").innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=otpauth://totp/${qr_inner['u']}?secret=${qr_inner['x']}">`
        document.getElementById("register-qr-label").innerHTML = `Codigo Qr, escanealo con <a target="_blank" href="https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2&hl=es&gl=US">google authenticator</a> o con cualquier aplicacion o pagina que soporte la generacion de codigos totp a partir de llaves, como <a href="https://totp.danhersam.com/" target="_blank">esta por ejemplo</a> o copia y pega el secreto = <code>${qr_inner['x']}</code>`
    }else{
        document.getElementById("register-qr").innerHTML = ''
        //document.getElementById("register-qr-label").innerHTML = `Codigo Qr, (cuando registres un nuevo usuario saldra aqui), escanealo con <a target="_blank" href="https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2&hl=es&gl=US">google authenticator</a> o con cualquier aplicacion o pagina que soporte la generacion de codigos totp a partir de llaves, como <a href="https://totp.danhersam.com/" target="_blank">esta por ejemplo</a>.`
        document.getElementById("register-qr-label").innerHTML = ''
    }
}

function hosthandle(confirm){
    if (confirm){
        document.getElementById("host").value = DEF_HOST
        console.log("host restablecido a "+DEF_HOST+" correctamente")
    }else{
        host = document.getElementById("host").value
    }
}

function json_formatter(json_data){
    return "<pre>"+JSON.stringify(JSON.parse(json_data), null, 4)+"</pre>"
}

function json_post(data){
    return {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        'body':data,
    }
}

function login(confirm){
    let send_json = JSON.stringify({
        'u':document.getElementById("login-usuario").value,
        'k':document.getElementById("login-totp").value
    })
    document.getElementById("login-in").innerHTML=json_formatter(send_json)
    if (confirm){
        document.getElementById("login-statuscode").innerHTML = ''
        fetch(host+'/login',json_post(send_json))
        .then(response => {
            document.getElementById("login-statuscode").innerHTML = response.status.toString()+' '+response.statusText.toUpperCase()
            return response.json()
          })
        .then(responseData => {
            document.getElementById("login-out").innerHTML = json_formatter(JSON.stringify(responseData))
        })
        .catch(error => {
            console.warn(error)
            document.getElementById("login-out").innerHTML='{}'
        })
    }
}

function register(confirm){
    let user = document.getElementById("register-usuario").value
    let send_json = JSON.stringify({
        's' : document.getElementById("register-token").value,
        'u' : user,
        'a' : document.getElementById("register-access").value,
        'fn' : document.getElementById("register-fn").value,
        'ln' : document.getElementById("register-ln").value,
    })
    document.getElementById("register-in").innerHTML=json_formatter(send_json)
    qr_inner = {}
    qrmadein()
    if (confirm){
        document.getElementById("register-statuscode").innerHTML = ''
        fetch(host+'/register',json_post(send_json))
        .then(response => {
            document.getElementById("register-statuscode").innerHTML = response.status.toString()+' '+response.statusText.toUpperCase()
            return response.json()
          })
        .then(responseData => {
            document.getElementById("register-out").innerHTML = json_formatter(JSON.stringify(responseData))
            qr_inner = {"u":user,"x":responseData['x']}
            qrmadein()
        })
        .catch(error => {
            qr.innerHTML = ""
            console.warn(error)
            document.getElementById("register-out").innerHTML='{}'
        })
    }
}

function logout(confirm){
    let send_json = JSON.stringify({
        's':document.getElementById("logout-session").value,
        'all':document.getElementById("logout-all").checked
    })
    document.getElementById("logout-in").innerHTML=json_formatter(send_json)
    if (confirm){
        document.getElementById("logout-statuscode").innerHTML = ''
        fetch(host+'/logout',json_post(send_json))
        .then(response => {
            document.getElementById("logout-statuscode").innerHTML = response.status.toString()+' '+response.statusText.toUpperCase()
            return response.json()
          })
        .then(responseData => {
            document.getElementById("logout-out").innerHTML = json_formatter(JSON.stringify(responseData))
        })
        .catch(error => {
            console.warn(error)
            document.getElementById("logout-out").innerHTML='{}'
        })
    }
}

function unregister(confirm){
    let send_json = JSON.stringify({
        'u':document.getElementById("unregister-usuario").value,
        'k':document.getElementById("unregister-totp").value
    })
    document.getElementById("unregister-in").innerHTML=json_formatter(send_json)
    if (confirm){
        document.getElementById("unregister-statuscode").innerHTML = ''
        fetch(host+'/unregister',json_post(send_json))
        .then(response => {
            document.getElementById("unregister-statuscode").innerHTML = response.status.toString()+' '+response.statusText.toUpperCase()
            return response.json()
          })
        .then(responseData => {
            document.getElementById("unregister-out").innerHTML = json_formatter(JSON.stringify(responseData))
        })
        .catch(error => {
            console.warn(error)
            document.getElementById("unregister-out").innerHTML='{}'
        })
    }
}

function userinfo(confirm){
    function checkall(){
        document.getElementById("userinfo-id").checked = true
        document.getElementById("userinfo-user").checked = true
        document.getElementById("userinfo-name").checked = true
        document.getElementById("userinfo-lname").checked = true
        document.getElementById("userinfo-access").checked = true
        document.getElementById("userinfo-create").checked = true
        for (let i = 0; i < infolst.length ;  i++){
            info[infolst[i]]=true
        }
        userinfo(false)
    }
    let url_arguments = ''
    let session = document.getElementById("userinfo-session").value
    url_arguments += '/' + session
    let users = document.getElementById("userinfo-users").value
    let all_users = document.getElementById("userinfo-all-users").checked
    let infolst = ['id','u','fn','ln','a','ca']
    let info = {
        'id' : document.getElementById("userinfo-id").checked,
        'u' : document.getElementById("userinfo-user").checked,
        'fn' : document.getElementById("userinfo-name").checked,
        'ln' : document.getElementById("userinfo-lname").checked,
        'a' : document.getElementById("userinfo-access").checked,
        'ca' : document.getElementById("userinfo-create").checked
    }
    let limit = document.getElementById("userinfo-limit").value
    let offset = document.getElementById("userinfo-offset").value

    if(all_users){
        document.getElementById("userinfo-users").value = 'all'
        document.getElementById("userinfo-users").disabled = true
    }else{
        if(document.getElementById("userinfo-users").value == 'all'){
            document.getElementById("userinfo-users").disabled = false
            document.getElementById("userinfo-users").value = ''
        }
    }
    url_arguments += '?user='
    url_arguments += (users!='')?users:'all'
    url_arguments += '&info='
    let j = 0
    for (let i = 0; i < infolst.length ;  i++){
        if(info[infolst[i]]){
            j++
        }
    }
    if(j==0)checkall()
    let k = 0
    for (let i = 0; i <= infolst.length ;  i++){
        if (info[infolst[i]]){
            url_arguments += (k>0)?',':''
            url_arguments += infolst[i]
            k++
        }
    }
    if(limit!=100)url_arguments += '&limit=' + limit
    if(offset!=0)url_arguments += '&offset=' + offset
    document.getElementById("userinfo-in").innerHTML = '/userinfo' + url_arguments
    if(confirm==true){
        fetch(host+'/userinfo'+url_arguments)
        .then(response => {
            console.log(response.status)
            document.getElementById("userinfo-statuscode").innerHTML = response.status.toString()+' '+response.statusText.toUpperCase()
            return response.json()
          })
        .then(responseData => {
            document.getElementById("userinfo-out").innerHTML = json_formatter(JSON.stringify(responseData))
        })
        .catch(error => {
            console.warn(error)
            document.getElementById("userinfo-out").innerHTML='{}'
        })
    }else if (confirm==2){
        checkall()
    }
}

function test(confirm){
    let url_arguments = ''
    if(document.getElementById("test-url").value!=''){
        url_arguments+='/'+document.getElementById("test-url").value.replace(/,/g,'/')
    }
    if(document.getElementById("test-uri").value!=''){
        url_arguments+='?'+document.getElementById("test-uri").value.replace(/,/g,'&')
    }
    document.getElementById("test-in").innerHTML = '/test' + url_arguments
    if (confirm){
        document.getElementById("test-statuscode").innerHTML = ''
        fetch(host+'/test'+url_arguments)
        .then(response => {
            console.log(response.status)
            document.getElementById("test-statuscode").innerHTML = response.status.toString()+' '+response.statusText.toUpperCase()
            return response.json()
          })
        .then(responseData => {
            document.getElementById("test-out").innerHTML = json_formatter(JSON.stringify(responseData))
        })
        .catch(error => {
            console.warn(error)
            document.getElementById("test-out").innerHTML='{}'
        })
    }
}

function hostez(bool){
    //en desarrollo
    let prefix=`
    <br>
    <label>modo facil</label>
    <input type="checkbox" value="true" onchange="hostez()">
    `
    let sufix=`
        <table>
            <tr>
                <th>
                    Protocolo
                </th>
                <th></th>
                <th>
                    Direccion del servidor
                </th>
                <th></th>
                <th>
                    Puerto
                </th>
                <th></th>
                <th>
                    API Endpoint
                </th>
            </tr>
            <tr>
                <th>
                    <select id="protocol" onchange="hostez()">
                        <option>http</option>
                        <option>https</option>
                    </select>
                </th>
                <th>
                    <span>://</span>
                </th>
                <th>
                    <input type="text" id="hostin" placeholder="www.example.com" oninput="hostez()">
                </th>
                <th>
                    <span>:</span>
                </th>
                <th>
                    <input type="number" id="port" value="80" min="0" size="6" placeholder="80" oninput="hostez()">
                </th>
                <th>
                    <span>/</span>
                </th>
                <th>
                    <input type="text" id="endpoint" placeholder="api" oninput="hostez()">
                </th>
            </tr>
        </table>
    `
//document.getElementById("hostez").innerHTML=base
}
</script>
</body>
</html>
